import streamlit as st
import openai
import pandas as pd

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª—é—á–∞ OpenAI
openai.api_key = st.secrets["OPENAI_API_KEY"]

st.set_page_config(page_title="AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤", layout="wide")
st.title("ü§ñ AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤ –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π")

# --- –°–µ–∫—Ü–∏—è –≤–≤–æ–¥–∞ ---
st.sidebar.header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
subject = st.sidebar.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç", ["–§–∏–∑–∏–∫–∞", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–ë–∏–æ–ª–æ–≥–∏—è", "–•–∏–º–∏—è", "–ò—Å—Ç–æ—Ä–∏—è"])
grade = st.sidebar.selectbox("–ö–ª–∞—Å—Å", list(range(1, 12)))
difficulty = st.sidebar.selectbox("–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏", ["–õ–µ–≥–∫–∏–π", "–°—Ä–µ–¥–Ω–∏–π", "–°–ª–æ–∂–Ω—ã–π"])
num_tasks = st.sidebar.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π", min_value=1, max_value=20, value=5)

prompt = st.text_area("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∑–∞–¥–∞–Ω–∏–π:", "")

# --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏–π ---
if st.button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–π –ª–∏—Å—Ç"):
    if prompt.strip() == "":
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞!")
    else:
        with st.spinner("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è..."):
            response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=[
                    {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —É—á–∏—Ç–µ–ª—è, —Å–æ–∑–¥–∞—é—â–∏–π –≥–æ—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è, —Ç–µ—Å—Ç—ã –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."},
                    {"role": "user", "content": f"–°–æ–∑–¥–∞–π {num_tasks} –∑–∞–¥–∞–Ω–∏–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É {subject}, –¥–ª—è {grade} –∫–ª–∞—Å—Å–∞, —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ {difficulty}, –ø–æ —Ç–µ–º–µ: {prompt}. –ü—Ä–µ–¥—Å—Ç–∞–≤—å –∏—Ö –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: '‚Ññ', '–ó–∞–¥–∞–Ω–∏–µ', '–¢–∏–ø' (—Ç–µ—Å—Ç/—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ/–∑–∞–¥–∞—á–∞)."}
                ],
                temperature=0.7,
                max_tokens=1200
            )
            tasks_text = response['choices'][0]['message']['content']

            # –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ —Ç–∞–±–ª–∏—Ü—É
            try:
                df = pd.read_csv(pd.compat.StringIO(tasks_text), sep="|")
                st.dataframe(df)
            except:
                st.text(tasks_text)

        st.success("–ì–æ—Ç–æ–≤–æ! –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –≤ PDF/Excel.")
